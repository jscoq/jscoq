From de9ce14121ab72a149d0cf863833633d5fa06893 Mon Sep 17 00:00:00 2001
From: Emilio Jesus Gallego Arias <e+git@x80.org>
Date: Thu, 22 Sep 2022 17:35:33 +0200
Subject: [PATCH] pcoq latency fix

---
 clib/cList.ml   | 6 +++---
 clib/cList.mli  | 2 +-
 parsing/pcoq.ml | 4 +++-
 3 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/clib/cList.ml b/clib/cList.ml
index 738a97b..449b31c 100644
--- a/clib/cList.ml
+++ b/clib/cList.ml
@@ -92,7 +92,7 @@ sig
   val skipn_at_least : int -> 'a list -> 'a list
   val drop_prefix : 'a eq -> 'a list -> 'a list -> 'a list
   val insert : ('a -> 'a -> bool) -> 'a -> 'a list -> 'a list
-  val share_tails : 'a list -> 'a list -> 'a list * 'a list * 'a list
+  val share_tails : ('a -> 'a -> bool) -> 'a list -> 'a list -> 'a list * 'a list * 'a list
   val map_assoc : ('a -> 'b) -> ('c * 'a) list -> ('c * 'b) list
   val assoc_f : 'a eq -> 'a -> ('a * 'b) list -> 'b
   val remove_assoc_f : 'a eq -> 'a -> ('a * 'b) list -> ('a * 'b) list
@@ -794,9 +794,9 @@ let drop_prefix cmp p l =
   in
   drop_prefix_rec (p,l)
 
-let share_tails l1 l2 =
+let share_tails eq l1 l2 =
   let rec shr_rev acc = function
-    | (x1 :: l1, x2 :: l2) when x1 == x2 -> shr_rev (x1 :: acc) (l1,l2)
+    | (x1 :: l1, x2 :: l2) when eq x1 x2 -> shr_rev (x1 :: acc) (l1,l2)
     | (l1, l2) -> (List.rev l1, List.rev l2, acc)
   in
   shr_rev [] (List.rev l1, List.rev l2)
diff --git a/clib/cList.mli b/clib/cList.mli
index fdeff75..99640e2 100644
--- a/clib/cList.mli
+++ b/clib/cList.mli
@@ -285,7 +285,7 @@ sig
   (** Insert at the (first) position so that if the list is ordered wrt to the
       total order given as argument, the order is preserved *)
 
-  val share_tails : 'a list -> 'a list -> 'a list * 'a list * 'a list
+  val share_tails : ('a -> 'a -> bool) -> 'a list -> 'a list -> 'a list * 'a list * 'a list
   (** [share_tails l1 l2] returns [(l1',l2',l)] such that [l1] is
       [l1'\@l] and [l2] is [l2'\@l] and [l] is maximal amongst all such
       decompositions *)
diff --git a/parsing/pcoq.ml b/parsing/pcoq.ml
index 7415979..6a68f5f 100644
--- a/parsing/pcoq.ml
+++ b/parsing/pcoq.ml
@@ -432,10 +432,12 @@ type frozen_t =
 let freeze ~marshallable : frozen_t =
   (!grammar_stack, CLexer.get_keyword_state ())
 
+let eq_grams x y = x = y
+
 (* We compare the current state of the grammar and the state to unfreeze,
    by computing the longest common suffixes *)
 let factorize_grams l1 l2 =
-  if l1 == l2 then ([], [], l1) else List.share_tails l1 l2
+  if l1 == l2 then ([], [], l1) else List.share_tails eq_grams l1 l2
 
 let rec number_of_entries accu = function
 | [] -> accu
-- 
2.34.1

